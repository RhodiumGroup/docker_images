services:
  - docker

env:
  jobs:
    - IMAGE_NAME=notebook
    - IMAGE_NAME=worker
  global:
    - CLAWPACK_COMMIT=5f6f94c6087c520e29fbdaf823965c2d8e2ec6b2

install:
- "cp -r shared_resources $IMAGE_NAME/shared_resources && chmod -R +x \
    $IMAGE_NAME/shared_resources"
- "if [[ \"$TRAVIS_TAG\" == \"\" ]]; then
    export WORKER_IMAGE=gcr.io/rhg-project-1/pytc-image-gateway:latest;
    export SCHEDULER_IMAGE=rhodium/scheduler:\"$TRAVIS_COMMIT\";
  else
    export WORKER_IMAGE=gcr.io/rhg-project-1/pytc-image-gateway:latest;
    export SCHEDULER_IMAGE=rhodium/scheduler:\"$TRAVIS_TAG\";
  fi;"
- echo $WORKER_IMAGE
- echo $SCHEULER_IMAGE
- "if [[ $IMAGE_NAME == worker ]]; then cp -r shared_resources \
    octave-worker/shared_resources && chmod -R +x octave-worker/shared_resources; fi"
- cd $IMAGE_NAME


script:
- "if [[ $IMAGE_NAME == worker ]]; then docker build -t \
    rhodium/scheduler:local -f Dockerfile_scheduler .; fi"
- "travis_wait 90 docker build -t rhodium/$IMAGE_NAME:$TRAVIS_COMMIT \
    --build-arg CLAWPACK_COMMIT --build-arg WORKER_IMAGE --build-arg SCHEDULER_IMAGE ."
- "if [[ $IMAGE_NAME == worker ]]; then docker build -t \
    rhodium/octave-worker:$TRAVIS_COMMIT --build-arg TRAVIS_COMMIT=$TRAVIS_COMMIT \
    ../octave-worker; fi"
- docker run -t rhodium/$IMAGE_NAME:$TRAVIS_COMMIT bash /clawpack/run_tests.sh

deploy:
- provider: script
  script: >-
    docker tag rhodium/$IMAGE_NAME:$TRAVIS_COMMIT
    rhodium/$IMAGE_NAME:$TRAVIS_BRANCH &&
    docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
    docker push "rhodium/$IMAGE_NAME:$TRAVIS_COMMIT" &&
    docker push "rhodium/$IMAGE_NAME:$TRAVIS_BRANCH"
  on:
    all_branches: true
    condition: $TRAVIS_BRANCH != master

- provider: script
  script: >-
    docker tag rhodium/$IMAGE_NAME:$TRAVIS_COMMIT rhodium/$IMAGE_NAME:dev &&
    docker tag rhodium/$IMAGE_NAME:$TRAVIS_COMMIT rhodium/$IMAGE_NAME:latest &&
    docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
    docker push "rhodium/$IMAGE_NAME:$TRAVIS_COMMIT" &&
    docker push "rhodium/$IMAGE_NAME:dev" &&
    docker push "rhodium/$IMAGE_NAME:latest"
  on:
    branch: master

- provider: script
  script: >-
    docker tag rhodium/$IMAGE_NAME:$TRAVIS_COMMIT
    rhodium/$IMAGE_NAME:$TRAVIS_TAG &&
    docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
    docker push "rhodium/$IMAGE_NAME:$TRAVIS_TAG"
  on:
    tags: true

# scheduler builds
- provider: script
  script: >-
    docker tag rhodium/scheduler:local rhodium/scheduler:$TRAVIS_COMMIT &&
    docker tag rhodium/scheduler:local rhodium/scheduler:$TRAVIS_BRANCH &&
    docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
    docker push "rhodium/scheduler:$TRAVIS_COMMIT" &&
    docker push "rhodium/scheduler:$TRAVIS_BRANCH"
  on:
    all_branches: true
    condition: ($TRAVIS_BRANCH != master) && ($IMAGE_NAME == worker)

- provider: script
  script: >-
    docker tag rhodium/scheduler:local rhodium/scheduler:latest &&
    docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
    docker push "rhodium/scheduler:$TRAVIS_COMMIT" &&
    docker push "rhodium/scheduler:latest"
  on:
    branch: master
    condition: $IMAGE_NAME = worker

- provider: script
  script: >-
    docker tag rhodium/scheduler:local rhodium/scheduler:$TRAVIS_TAG &&
    docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
    docker push "rhodium/scheduler:$TRAVIS_TAG"
  on:
    tags: true
    condition: $IMAGE_NAME = worker

# octave-worker builds
- provider: script
  script: >-
    docker tag rhodium/octave-worker:$TRAVIS_COMMIT
    rhodium/octave-worker:$TRAVIS_BRANCH &&
    docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
    docker push "rhodium/octave-worker:$TRAVIS_COMMIT" &&
    docker push "rhodium/octave-worker:$TRAVIS_BRANCH"
  on:
    all_branches: true
    condition: ($TRAVIS_BRANCH != master) && ($IMAGE_NAME == worker)

- provider: script
  script: >-
    docker tag rhodium/octave-worker:$TRAVIS_COMMIT
    rhodium/octave-worker:dev &&
    docker tag rhodium/octave-worker:$TRAVIS_COMMIT
    rhodium/octave-worker:latest &&
    docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
    docker push "rhodium/octave-worker:$TRAVIS_COMMIT" &&
    docker push "rhodium/octave-worker:dev" &&
    docker push "rhodium/octave-worker:latest"
  on:
    branch: master
    condition: $IMAGE_NAME = worker

- provider: script
  script: >-
    docker tag rhodium/octave-worker:$TRAVIS_COMMIT
    rhodium/octave-worker:$TRAVIS_TAG &&
    docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
    docker push "rhodium/octave-worker:$TRAVIS_TAG"
  on:
    tags: true
    condition: $IMAGE_NAME = worker