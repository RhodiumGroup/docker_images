sudo: required
services:
  - docker

env:
  global:
    - TAG=2018-07-12.01
  matrix:
    - IMAGE_NAME=notebook
    - IMAGE_NAME=worker
    - IMAGE_NAME=worker-tc

install:
  - cd $IMAGE_NAME
  - docker build --pull --cache-from rhodium/$IMAGE_NAME -t rhodium/$IMAGE_NAME:$TAG .

script:
  - docker images rhodium/$IMAGE_NAME:$TAG

deploy:
  provider: script
  script: docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" && docker push "rhodium/$IMAGE_NAME:$TAG"
  skip_cleanup: true
  on:
    branch: master
after_deploy:
  on:
    branch: master 
  install: 
    - curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get | bash
    - pip install --default-timeout=100 git+https://github.com/RhodiumGroup/helm-chart.git
  sript: 
    - cd helm-chart
    - python update_helm_tag.py -$TAG
    - helm package rhg-hub/
    - git checkout gh-pages
    - git add rhg-hub*.tgz
    - helm repo index .
    - git commit -am 'add new helm chart tag=$TAG'
    - git push 
