sudo: required
services:
  - docker
env:
  global:
    - TAG=2018-07-28.04
  matrix:
    - IMAGE_NAME=notebook
    - IMAGE_NAME=worker
install:
  - cd $IMAGE_NAME
  - docker pull rhodium/$IMAGE_NAME:latest
  - docker build --pull --cache-from rhodium/$IMAGE_NAME:latest -t rhodium/$IMAGE_NAME:$TAG .
  - docker tag rhodium/$IMAGE_NAME:$TAG rhodium/$IMAGE_NAME:latest
script:
  - docker images rhodium/$IMAGE_NAME:$TAG
  - docker images rhodium/$IMAGE_NAME:latest
deploy:
  provider: script
  script: docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" && docker push "rhodium/$IMAGE_NAME:$TAG" && docker push "rhodium/$IMAGE_NAME:latest"
  skip_cleanup: true
  on:
    branch: master
