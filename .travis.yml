sudo: required

language: python

services:
  - docker

build-stage1: &build-stage1
  stage: build-stage1
  script:
    - "if [[ \"$TRAVIS_TAG\" == \"\" ]]; then sed -i.bak 's/image: rhodium\\/worker.*/image: rhodium\\/worker:'\"$TRAVIS_COMMIT\"'/' notebook/worker-template.yml; else sed -i.bak 's/image: rhodium\\/worker:.*/image: rhodium\\/worker:'\"$TRAVIS_TAG\"'/' notebook/worker-template.yml; fi"
    - rm notebook/worker-template.yml.bak
    - "cat notebook/worker-template.yml | grep image:"
    - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
    - docker pull rhodium/$IMAGE_NAME:$TRAVIS_BRANCH-stage1 || true
    - cd $IMAGE_NAME
    - docker build --pull --cache-from rhodium/$IMAGE_NAME:$TRAVIS_BRANCH-stage1 -t rhodium/$IMAGE_NAME:$TRAVIS_COMMIT-stage1 -f Dockerfile.stage1 .
    - docker push rhodium/$IMAGE_NAME:$TRAVIS_COMMIT-stage1
    - docker tag rhodium/$IMAGE_NAME:$TRAVIS_COMMIT-stage1 rhodium/$IMAGE_NAME:$TRAVIS_BRANCH-stage1
    - docker push rhodium $IMAGE_NAME:$TRAVIS_BRANCH-stage1
  skip_cleanup: true

build-stage2: &build-stage2
  stage: build-stage2
  script:
    - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
    - docker pull rhodium/$STAGE1_NAME:$TRAVIS_COMMIT-stage1
    - docker pull rhodium/$IMAGE_NAME:dev
    - docker build --pull --cache-from rhodium/$IMAGE_NAME:dev -t rhodium/$IMAGE_NAME:$TRAVIS_COMMIT --build-arg STAGE1_TAG=$TRAVIS_COMMIT-stage1 -f $IMAGE_NAME/Dockerfile.stage2 $IMAGE_NAME
    - docker push rhodium/$IMAGE_NAME:$TRAVIS_COMMIT
  skip_cleanup: true

deploy-branch: &deploy-branch
  stage: deploy
  script:
    - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
    - docker pull rhodium/$IMAGE_NAME:$TRAVIS_COMMIT
    - docker tag rhodium/$IMAGE_NAME:$TRAVIS_COMMIT rhodium/$IMAGE_NAME:$TRAVIS_BRANCH
    - docker push rhodium/$IMAGE_NAME:$TRAVIS_BRANCH
  skip_cleanup: true
  if: branch != master

deploy-master: &deploy-master
  stage: deploy
  script:
    - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
    - docker pull rhodium/$IMAGE_NAME:$TRAVIS_COMMIT
    - docker tag rhodium/$IMAGE_NAME:$TRAVIS_COMMIT rhodium/$IMAGE_NAME:dev
    - docker tag rhodium/$IMAGE_NAME:$TRAVIS_COMMIT rhodium/$IMAGE_NAME:latest
    - docker push rhodium/$IMAGE_NAME:dev
    - docker push rhodium/$IMAGE_NAME:latest
  skip_cleanup: true
  if: branch = master

deploy-tag: &deploy-tag
  stage: deploy
  script:
    - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
    - docker pull rhodium/$IMAGE_NAME:$TRAVIS_COMMIT
    - docker tag rhodium/$IMAGE_NAME:$TRAVIS_COMMIT rhodium/$IMAGE_NAME:$TRAVIS_TAG
    - docker push rhodium/$IMAGE_NAME:$TRAVIS_TAG
  skip_cleanup: true
  if:
    tag IS present

jobs:
  include:
    - <<: *build-stage1
      env:
        IMAGE_NAME=notebook
    - <<: *build-stage1
      env:
        IMAGE_NAME=worker-base
    - <<: *build-stage2
      env:
        IMAGE_NAME=notebook
        STAGE1_NAME=notebook
    - <<: *build-stage2
      env:
        IMAGE_NAME=worker
        STAGE1_NAME=worker-base
    - <<: *build-stage2
      env:
        IMAGE_NAME=octave-worker
        STAGE1_NAME=worker-base
    - <<: *deploy-branch
      env:
        IMAGE_NAME=notebook
    - <<: *deploy-branch
      env:
        IMAGE_NAME=worker
    - <<: *deploy-branch
      env:
        IMAGE_NAME=octave-worker
    - <<: *deploy-master
      env:
        IMAGE_NAME=notebook
    - <<: *deploy-master
      env:
        IMAGE_NAME=worker
    - <<: *deploy-master
      env:
        IMAGE_NAME=octave-worker
    - <<: *deploy-tag
      env:
        IMAGE_NAME=notebook
    - <<: *deploy-tag
      env:
        IMAGE_NAME=worker
    - <<: *deploy-tag
      env:
        IMAGE_NAME=octave-worker
