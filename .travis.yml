services:
  - docker

env:
  global:
    - CLAWPACK_COMMIT=ed99e8b925260e45149d49c16d8df34bdeb9ac4c

jobs:
  include:
    - stage: deploy worker and intermediate notebook
      name: worker builds
      install:
        - "cp -r shared_resources worker/shared_resources && chmod -R +x \
            worker/shared_resources"
        - "cp -r shared_resources octave-worker/shared_resources && chmod -R +x \
            octave-worker/shared_resources"
        - cd worker
      script:
        - docker build -t rhodium/scheduler:local -f Dockerfile_scheduler .
        - "travis_wait 90 docker build -t rhodium/worker:$TRAVIS_COMMIT \
            --build-arg CLAWPACK_COMMIT ."
        - "docker build -t rhodium/octave-worker:$TRAVIS_COMMIT \
            --build-arg TRAVIS_COMMIT=$TRAVIS_COMMIT \
            ../octave-worker; fi"
        - docker run -t rhodium/worker:$TRAVIS_COMMIT bash /clawpack/run_tests.sh
      deploy:
        - provider: script
          script: >-
            docker tag rhodium/worker:$TRAVIS_COMMIT
            rhodium/worker:$TRAVIS_BRANCH &&
            docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
            docker push "rhodium/worker:$TRAVIS_COMMIT" &&
            docker push "rhodium/worker:$TRAVIS_BRANCH"
          on:
            all_branches: true
            condition: $TRAVIS_BRANCH != master
        - provider: script
          script: >-
            docker tag rhodium/worker:$TRAVIS_COMMIT rhodium/worker:dev &&
            docker tag rhodium/worker:$TRAVIS_COMMIT rhodium/worker:latest &&
            docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
            docker push "rhodium/worker:$TRAVIS_COMMIT" &&
            docker push "rhodium/worker:dev" &&
            docker push "rhodium/worker:latest"
          on:
            branch: master
        - provider: script
          script: >-
            docker tag rhodium/worker:$TRAVIS_COMMIT
            rhodium/worker:$TRAVIS_TAG &&
            docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
            docker push "rhodium/worker:$TRAVIS_TAG"
          on:
            tags: true
        # scheduler builds
        - provider: script
          script: >-
            docker tag rhodium/scheduler:local rhodium/scheduler:$TRAVIS_COMMIT &&
            docker tag rhodium/scheduler:local rhodium/scheduler:$TRAVIS_BRANCH &&
            docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
            docker push "rhodium/scheduler:$TRAVIS_COMMIT" &&
            docker push "rhodium/scheduler:$TRAVIS_BRANCH"
          on:
            all_branches: true
            condition: $TRAVIS_BRANCH != master
        - provider: script
          script: >-
            docker tag rhodium/scheduler:local rhodium/scheduler:latest &&
            docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
            docker push "rhodium/scheduler:$TRAVIS_COMMIT" &&
            docker push "rhodium/scheduler:latest"
          on:
            branch: master
        - provider: script
          script: >-
            docker tag rhodium/scheduler:local rhodium/scheduler:$TRAVIS_TAG &&
            docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
            docker push "rhodium/scheduler:$TRAVIS_TAG"
          on:
            tags: true
        # octave-worker builds
        - provider: script
          script: >-
            docker tag rhodium/octave-worker:$TRAVIS_COMMIT
            rhodium/octave-worker:$TRAVIS_BRANCH &&
            docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
            docker push "rhodium/octave-worker:$TRAVIS_COMMIT" &&
            docker push "rhodium/octave-worker:$TRAVIS_BRANCH"
          on:
            all_branches: true
            condition: $TRAVIS_BRANCH != master
        - provider: script
          script: >-
            docker tag rhodium/octave-worker:$TRAVIS_COMMIT
            rhodium/octave-worker:dev &&
            docker tag rhodium/octave-worker:$TRAVIS_COMMIT
            rhodium/octave-worker:latest &&
            docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
            docker push "rhodium/octave-worker:$TRAVIS_COMMIT" &&
            docker push "rhodium/octave-worker:dev" &&
            docker push "rhodium/octave-worker:latest"
          on:
            branch: master
        - provider: script
          script: >-
            docker tag rhodium/octave-worker:$TRAVIS_COMMIT
            rhodium/octave-worker:$TRAVIS_TAG &&
            docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
            docker push "rhodium/octave-worker:$TRAVIS_TAG"
          on:
            tags: true
    - name: notebook builds
      install:
        - "cp -r shared_resources notebook/shared_resources && chmod -R +x \
            notebook/shared_resources"
        - cd notebook
      script:
        - travis_wait 90 docker build -t rhodium/notebook-tmp:$TRAVIS_COMMIT .
      deploy:
        - provider: script
          script: >-
            docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
            docker push "rhodium/notebook-tmp:$TRAVIS_COMMIT"
          on:
            all_branches: true
    - stage: test and deploy full notebook
      install:
        - "cp -r shared_resources notebook/shared_resources && chmod -R +x \
            notebook/shared_resources"
        - cd notebook
      script:
        - "travis_wait 90 docker build -t rhodium/notebook:$TRAVIS_COMMIT \
          -f Dockerfile_clawpack --build-arg TRAVIS_COMMIT ."
        - docker run -t rhodium/notebook:$TRAVIS_COMMIT bash /clawpack/run_tests.sh
      deploy:
        - provider: script
          script: >-
            docker tag rhodium/notebook:$TRAVIS_COMMIT
            rhodium/notebook:$TRAVIS_BRANCH &&
            docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
            docker push "rhodium/notebook:$TRAVIS_COMMIT" &&
            docker push "rhodium/notebook:$TRAVIS_BRANCH"
          on:
            all_branches: true
            condition: $TRAVIS_BRANCH != master

        - provider: script
          script: >-
            docker tag rhodium/notebook:$TRAVIS_COMMIT rhodium/notebook:dev &&
            docker tag rhodium/notebook:$TRAVIS_COMMIT rhodium/notebook:latest &&
            docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
            docker push "rhodium/notebook:$TRAVIS_COMMIT" &&
            docker push "rhodium/notebook:dev" &&
            docker push "rhodium/notebook:latest"
          on:
            branch: master
        - provider: script
          script: >-
            docker tag rhodium/notebook:$TRAVIS_COMMIT
            rhodium/notebook:$TRAVIS_TAG &&
            docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
            docker push "rhodium/notebook:$TRAVIS_TAG"
          on:
            tags: true