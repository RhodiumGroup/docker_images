sudo: required
services:
  - docker

env: 
  - TAG=2018-07-11.01

install:
  - cd notebook
  - docker build --pull --cache-from rhodium/notebook -t rhodium/notebook:$TAG .
  - cd ../worker
  - docker build --pull --cache-from rhodium/worker -t rhodium/worker:$TAG .
  - cd ../worker-tc
  - docker build --pull --cache-from rhodium/worker-tc -t rhodium/worker-tc:$TAG .

script:
  - docker images rhodium/notebook:$TAG
  - docker images rhodium/worker:$TAG
  - docker images rhodium/worker-tc:$TAG

deploy:
  provider: script
  script: docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" && docker push "rhodium/notebook:$TAG" && docker push "rhodium/worker:$TAG" && docker push "rhodium/worker-tc:$TAG"
  skip_cleanup: true
  on:
    branch: master
