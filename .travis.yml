sudo: required
services:
  - docker

env:
  global:
    - TAG=2018-07-17.01
  matrix:
    - IMAGE_NAME=notebook
    - IMAGE_NAME=worker
    - IMAGE_NAME=worker-tc

install:
  - cd $IMAGE_NAME
  - docker build rhodium/$IMAGE_NAME -t rhodium/$IMAGE_NAME:$TAG .

script:
  - docker images rhodium/$IMAGE_NAME:$TAG

deploy:
  provider: script
  script: docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" && docker push "rhodium/$IMAGE_NAME:$TAG"
  skip_cleanup: true
  on:
    branch: master
after_deploy:
  install:
    #install helm
    - curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get | bash
    # set-up deploy key
    - openssl aes-256-cbc -K $encrypted_19fb998dc11c_key -iv $encrypted_19fb998dc11c_iv -in github_deploy_key.enc -out github_deploy_key -d
    #clone our helm repo
    - git clone git@github.com:RhodiumGroup/helm-chart.git
    #update the tag for the helm chart
    - cd helm-chart
    - python update_helm_tag.py -$TAG
    #create the helm chart with the new tag
    - helm package rhg-hub/
    #add information to gh-pages repo
    - git checkout gh-pages
    - git add rhg-hub*.tgz
    - helm repo index .
    - git commit -am 'add new helm chart tag=$TAG'
    #push to gh-pages
    - git push 
  on:
    branch: master
