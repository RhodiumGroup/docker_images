sudo: required
services:
  - docker
env:
  global:
    - TAG=2018-08-13.01
  matrix:
    - IMAGE_NAME=notebook
    - IMAGE_NAME=worker
install:
  - cd $IMAGE_NAME
  - docker pull rhodium/$IMAGE_NAME:dev
  - docker build --pull --cache-from rhodium/$IMAGE_NAME:dev -t rhodium/$IMAGE_NAME:$TAG .
script:
  - docker images rhodium/$IMAGE_NAME:$TAG
deploy:
  - provider: script
    script: docker tag rhodium/$IMAGE_NAME:$TAG rhodium/$IMAGE_NAME:dev && docker tag rhodium/$IMAGE_NAME:$TAG rhodium/$IMAGE_NAME:$TRAVIS_COMMIT && docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" && docker push "rhodium/$IMAGE_NAME:$TAG" && docker push "rhodium/$IMAGE_NAME:dev" && docker push "rhodium/$IMAGE_NAME:$TRAVIS_COMMIT"
    skip_cleanup: true
    on:
      branch: dev
  - provider: script
    script: docker tag rhodium/$IMAGE_NAME:$TAG rhodium/$IMAGE_NAME:dev && docker tag rhodium/$IMAGE_NAME:$TAG rhodium/$IMAGE_NAME:$TRAVIS_COMMIT && rhodium/$IMAGE_NAME:latest && docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" && docker push "rhodium/$IMAGE_NAME:$TAG" && docker push "rhodium/$IMAGE_NAME:dev" && docker push "rhodium/$IMAGE_NAME:latest" && docker push "rhodium/$IMAGE_NAME:$TRAVIS_COMMIT"
    skip_cleanup: true
    on:
      branch: master

