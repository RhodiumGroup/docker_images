services:
  - docker

env:
  matrix:
    - IMAGE_NAME=notebook
    - IMAGE_NAME=worker  
  global:
    secure: FD1HCYWd/H7VDC2O+bWkJP4WooHigMW0XWqcbKZ+M5dYwVzzDeAgds36CT6Le+kREvKbmaDPxGDCoW33Ceu96lgZWla1Le0YjdJyiyvx34dGJnX3IrucRXbvc3+UN+qwfOj8UMadPGexVwcgcWSTIc0fwdibW9fE020fQF47XgxsXU5Ouro0e0ktvqfTs2revr2sU5aMDyxs4wyfVo8K905LfrqGSbIBSPCcjxLK9clByRNwwr4rWfSocBKnIF9xq6H4piDnC67rWfymTW4Lr9H9AMbH/kVErTAc+RACgmjVKMKYhP2DHk2N3SwE7bzcCgEkgj6LoC/8mogrY0Sml6Wa2zvNuFBzsSgocb07fGV/cPCFzgmqI6fLNtmDdrK5t5MEAvFB3XhsNgI8S04Rtzgijfp5tEEs53JAOjty3Uajv+pnrJOSP+ilo4VxB0aTpFJG0k+aCHLFY0lUuxWKEkgo3xRAhOgXmg1qbetarwR7EF4jQCEwARFlipbBHh8aJdTYSpqmLbrkzVU4luP3ycdFCea4b4HNfhC/OdnV+0j6NE8LEV29Sv8+QNbDeYJuexLJ3Kjo3BWkR1rVCa+ciqDoYBriPPTmQ1S/tj2ttFVZubyTx4u2yDP0ZMxeJsJvmCbFh2N+LujO4xTxadTcLMxadvCOJkB9w1i5XiO1Zg4=


install:
- "if [[ \"$TRAVIS_TAG\" == \"\" ]]; then 
    sed -i.bak \
      's/image: rhodium\\/worker.*/image: rhodium\\/worker:'\"$TRAVIS_COMMIT\"'/' \
      notebook/worker-template.yml; 
  else
    sed -i.bak \
      's/image: rhodium\\/worker:.*/image: rhodium\\/worker:'\"$TRAVIS_TAG\"'/' \
      notebook/worker-template.yml; fi"
- "rm notebook/worker-template.yml.bak"
- "cat notebook/worker-template.yml | grep image:"
- "cp base_environment.yml $IMAGE_NAME/base_environment.yml"
- "cp common.sh $IMAGE_NAME/common.sh && chmod +x $IMAGE_NAME/common.sh"
- "cd $IMAGE_NAME"


script:
- docker build -t rhodium/$IMAGE_NAME:$TRAVIS_COMMIT .

deploy:
- provider: script
  script: >-
    docker tag rhodium/$IMAGE_NAME:$TRAVIS_COMMIT
    rhodium/$IMAGE_NAME:$TRAVIS_BRANCH &&
    docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
    docker push "rhodium/$IMAGE_NAME:$TRAVIS_COMMIT" &&
    docker push "rhodium/$IMAGE_NAME:$TRAVIS_BRANCH"
  on:
    all_branches: true
    condition: $TRAVIS_BRANCH =~ ^dev

- provider: script
  script: >-
    docker tag rhodium/$IMAGE_NAME:$TRAVIS_COMMIT rhodium/$IMAGE_NAME:dev &&
    docker tag rhodium/$IMAGE_NAME:$TRAVIS_COMMIT rhodium/$IMAGE_NAME:latest &&
    docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
    docker push "rhodium/$IMAGE_NAME:$TRAVIS_COMMIT" &&
    docker push "rhodium/$IMAGE_NAME:dev" &&
    docker push "rhodium/$IMAGE_NAME:latest"
  on:
    branch: master

- provider: script
  script: >-
    docker tag rhodium/$IMAGE_NAME:$TRAVIS_COMMIT
    rhodium/$IMAGE_NAME:$TRAVIS_TAG &&
    docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
    docker push "rhodium/$IMAGE_NAME:$TRAVIS_TAG"
  on:
    tags: true

# octave-worker builds
- provider: script
  script: >-
    docker build -t rhodium/octave-worker:$TRAVIS_COMMIT
    --build-arg TRAVIS_COMMIT=$TRAVIS_COMMIT ../octave-worker &&
    docker tag rhodium/octave-worker:$TRAVIS_COMMIT
    rhodium/octave-worker:$TRAVIS_BRANCH &&
    docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
    docker push "rhodium/octave-worker:$TRAVIS_COMMIT" &&
    docker push "rhodium/octave-worker:$TRAVIS_BRANCH"
  on:
    all_branches: true
    condition: ("$TRAVIS_BRANCH" =~ "^dev") && ("$IMAGE_NAME" == "worker")

- provider: script
  script: >-
    docker tag rhodium/octave-worker:$TRAVIS_COMMIT
    rhodium/octave-worker:dev &&
    docker tag rhodium/octave-worker:$TRAVIS_COMMIT
    rhodium/octave-worker:latest &&
    docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
    docker push "rhodium/octave-worker:$TRAVIS_COMMIT" &&
    docker push "rhodium/octave-worker:dev" &&
    docker push "rhodium/octave-worker:latest"
  on:
    branch: master
    condition: $IMAGE_NAME = worker

- provider: script
  script: >-
    docker tag rhodium/octave-worker:$TRAVIS_COMMIT
    rhodium/octave-worker:$TRAVIS_TAG &&
    docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
    docker push "rhodium/octave-worker:$TRAVIS_TAG"
  on:
    tags: true
    condition: $IMAGE_NAME = worker

after_deploy:
  - node build_clawpack.js